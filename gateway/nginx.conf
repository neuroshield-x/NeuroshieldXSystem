server {
  listen 80;

  # ---------- Frontend (CRA dev @ :3000) ----------
  location / {
    proxy_pass http://frontend:3000/;   # keep slash for root
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }

  # CRA hot-reload WebSocket
  location /sockjs-node {
    proxy_pass http://frontend:3000/sockjs-node;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
  }

  # ---------- Alert API ----------
  location /api/alert/   { proxy_pass http://alert-api:8001/; }
  location = /api/logs   { proxy_pass http://log-ingestor:8004/api/logs; }
  location /api/logs/    { proxy_pass http://log-ingestor:8004/api/logs/; }
  location /api/analyze/ { proxy_pass http://alert-api:8001/api/analyze/; }
  location /api/detect/  { proxy_pass http://alert-api:8001/api/detect/; }

  # ---------- Anomaly Detector ----------
  location /api/anomaly/ { proxy_pass http://anomaly-detector:8002/; }

  # ---------- Explanation AI ----------
  # IMPORTANT: no trailing slash -> preserve /api/explain/ path
  location /api/explain/ { proxy_pass http://explanation-ai:8003; }

  # (Optional explicit health)
  location = /api/explain/health  { proxy_pass http://explanation-ai:8003/health; }
  location = /api/explain/health/ { proxy_pass http://explanation-ai:8003/health/; }

  # ---------- Log Ingestor ----------
  location /api/ingest/  { proxy_pass http://log-ingestor:8004/api/ingest/; }

  # ---------- Timeouts ----------
  proxy_read_timeout 120s;
  proxy_connect_timeout 30s;
  proxy_send_timeout 120s;
  client_max_body_size 10m;
}